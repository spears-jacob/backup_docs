USE ${env:ENVIRONMENT};

INSERT OVERWRITE TABLE ${env:dbprefix_events} PARTITION(partition_date_utc, partition_date_hour_utc)
SELECT
  MAX(domain),
  MAX(customer),
  MAX(received_timestamp),
  MAX(unfinished_created_timestamp),
  MAX(finished_created_timestamp),
  visit__visit_id,
  MAX(visit__previous_visit_id),
  MAX(visit__visit_start_timestamp),
  MAX(visit__visit_startup_time_ms),
  MAX(visit__application_statistics__days_since_last_upgrade),
  MAX(visit__application_statistics__launches),
  MAX(visit__application_statistics__days_since_last_use),
  MAX(visit__application_statistics__launches_since_upgrade),
  MAX(visit__application_statistics__days_since_first_use),
  MAX(visit__screen_resolution),
  visit__settings,
  MAX(visit__application_details__referrer_link),
  MAX(visit__application_details__application_name),
  MAX(visit__application_details__application_type),
  MAX(visit__application_details__app_version),
  MAX(visit__application_details__venona_version),
  visit__application_details__environment,
  MAX(visit__device__vendor_id),
  MAX(visit__device__device_form_factor),
  MAX(visit__device__device_type),
  MAX(visit__device__model),
  MAX(visit__device__operating_system),
  MAX(visit__device__enc_uuid),
  MAX(visit__device__available_storage),
  MAX(visit__device__device_build),
  MAX(visit__device__stb_is_dvr),
  MAX(visit__device__stb_name),
  MAX(visit__device__stb_device_id),
  MAX(visit__device__stb_old_name),
  MAX(visit__device__browser__name),
  MAX(visit__device__browser__user_agent),
  MAX(visit__device__browser__version),
  MAX(visit__device__linked_device__dvr_capable),
  MAX(visit__device__linked_device__name),
  MAX(visit__device__enc_linked_device__id),
  MAX(visit__login__failed_attempts),
  MAX(visit__login__login_duration_ms),
  MAX(visit__login__login_completed_timestamp),
  visit__video_zone__details,
  MAX(visit__video_zone__division),
  MAX(visit__video_zone__lineup),
  MAX(visit__isp__enc_ip_address),
  MAX(visit__isp__location_id),
  MAX(visit__isp__organization),
  MAX(visit__isp__isp),
  MAX(visit__isp__status),
  MAX(visit__connection__connection_type),
  MAX(visit__connection__network_status),
  MAX(visit__connection__network_cell_carrier),
  MAX(visit__connection__network_cell_network_type),
  MAX(visit__connection__speed_test__output),
  MAX(visit__connection__speed_test__start_timestamp),
  MAX(visit__connection__speed_test__end_timestamp),
  MAX(visit__account__enc_account_number),
  MAX(visit__account__address__address_type),
  MAX(visit__account__address__city),
  MAX(visit__account__address__state),
  MAX(visit__account__address__zip_code),
  visit__account__details,
  MAX(visit__account__subscription),
  MAX(visit__account__subscription__service_level),
  MAX(visit__account__status),
  MAX(visit__account__enc_account_enc_billing_division),
  MAX(visit__account__enc_account_billing_id),
  MAX(visit__account__enc_account_enc_billing_division_id),
  MAX(visit__account__account_intest_division),
  visit__account__demographic_data,
  MAX(visit__user__enc_id),
  MAX(visit__user__role),
  MAX(visit__user__is_test_user),
  MAX(visit__user__is_whitelisted),
  visit__user__details,
  MAX(visit__user__status),
  MAX(visit__location__country_code),
  MAX(visit__location__country_name),
  MAX(visit__location__region),
  MAX(visit__location__region_name),
  MAX(visit__location__enc_city),
  MAX(visit__location__state),
  MAX(visit__location__enc_zip_code),
  MAX(visit__location__enc_latitude),
  MAX(visit__location__enc_longitude),
  MAX(visit__location__metro_code),
  MAX(visit__location__area_code),
  MAX(visit__location__timezone),
  MAX(visit__location__status),
  MAX(visit__fips__fips_codes),
  MAX(visit__fips__fips_county),
  MAX(visit__fips__fips_county_section),
  MAX(visit__fips__fips_national),
  MAX(visit__fips__fips_state),
  MAX(application__drm_enabled),
  MAX(application__error__error_type),
  MAX(application__error__error_code),
  application__error__error_extras,
  MAX(application__error__error_message),
  MAX(application__api__response_code),
  MAX(application__api__service_result),
  MAX(application__api__response_text),
  MAX(application__api__response_time_ms),
  MAX(application__api__host),
  MAX(application__api__path),
  MAX(application__api__api_name),
  MAX(application__api__http_verb),
  MAX(application__api__api_cached),
  MAX(application__api__query_parameters),
  MAX(application__api__trace_id),
  MAX(message__category),
  MAX(message__name),
  message__sequence_number,
  message__timestamp,
  MAX(message__triggered_by),
  COLLECT_LIST(message__feature__name),
  MAX(message__feature__current_step),
  MAX(message__feature__number_of_steps),
  MAX(state__name),
  MAX(state__entry_timestamp),
  MAX(state__entry_video_position),
  MAX(state__current_video_position),
  MAX(state__previous_state__name),
  MAX(state__previous_state__entry_timestamp),
  MAX(state__previous_state__entry_video_position),
  MAX(state__previous_state__exit_timestamp),
  MAX(state__previous_state__exit_video_position),
  MAX(state__playback__playback_started_timestamp),
  MAX(state__playback__tune_time_ms),
  MAX(state__playback__uri_obtained_ms),
  MAX(state__playback__playback_selected_timestamp),
  MAX(state__playback__buffering_time_ms),
  MAX(state__playback__segment_count),
  MAX(state__playback__segment_download_duration_ms),
  MAX(state__playback__segment_ip),
  MAX(state__playback__segment_location),
  MAX(state__playback__heart_beat__clock_time_elapsed_sec),
  MAX(state__playback__heart_beat__content_elapsed_sec),
  MAX(state__playback__bit_rate__current_bit_rate),
  MAX(state__playback__bit_rate__content_elapsed_at_current_bit_rate_sec),
  MAX(state__playback__bit_rate__previous_bit_rate),
  MAX(state__playback__bit_rate__content_elapsed_at_previous_bit_rate_sec),
  MAX(state__playback__trick_play__scrub_speed),
  MAX(state__playback__trick_play__scrub_type),
  MAX(state__playback__trick_play__scrub_start_position),
  MAX(state__playback__trick_play__scrub_end_position),
  MAX(state__playback__segment_info__segment_is_ad),
  MAX(state__playback__segment_info__query_parameters),
  MAX(state__playback__segment_info__sequence_number),
  MAX(state__playback__segment_info__segment_url),
  MAX(state__playback__segment_info__size_bytes),
  MAX(state__playback__segment_info__download_duration_ms),
  MAX(state__playback__segment_info__ip_address),
  MAX(state__content__purchase_id),
  MAX(state__content__content_class),
  MAX(state__content__content_format),
  MAX(state__content__rental_duration_hours),
  MAX(state__content__rental_expiration_date),
  MAX(state__content__stream__content_uri),
  MAX(state__content__stream__playback_type),
  MAX(state__content__stream__streaming_format),
  MAX(state__content__stream__drm_type),
  MAX(state__content__stream__scrubbing_capability),
  MAX(state__content__stream__closed_captioning_capable),
  MAX(state__content__stream__sap_capable),
  MAX(state__content__stream__bookmark_position_sec),
  MAX(state__content__stream__entitled),
  MAX(state__content__stream__parentally_blocked),
  MAX(state__content__stream__playback_id),
  MAX(state__content__stream__price),
  MAX(state__content__stream__purchase_type),
  MAX(state__content__stream__start_timestamp),
  MAX(state__content__stream__end_timestamp),
  MAX(state__content__stream__recording_start_timestamp),
  MAX(state__content__stream__recording_stop_timestamp),
  MAX(state__content__stream__programmer_favorited),
  MAX(state__content__stream__programmer_call_sign),
  MAX(state__content__identifiers__dvr_recording_id),
  MAX(state__content__identifiers__provider_asset_id),
  MAX(state__content__identifiers__platform_series_id),
  MAX(state__content__identifiers__platform_asset_id),
  MAX(state__content__identifiers__tms_series_id),
  MAX(state__content__identifiers__tms_program_id),
  MAX(state__content__identifiers__tms_guide_id),
  MAX(state__content__details__program_type),
  MAX(state__content__details__title),
  MAX(state__content__details__episode_number),
  MAX(state__content__details__season_number),
  MAX(state__content__details__available_date),
  MAX(state__content__details__service_closed_captioned),
  MAX(state__content__details__edition),
  MAX(state__content__details__runtime),
  MAX(state__content__details__actual_runtime),
  MAX(state__content__details__expiration_date),
  MAX(state__content__details__original_air_date),
  MAX(state__content__details__original_network_name),
  MAX(state__content__details__rating__rating),
  MAX(state__content__details__rating__rating_type),
  MAX(state__content__details__description),
  MAX(state__content__details__year),
  MAX(state__content__details__episode_title),
  MAX(state__content__details__content_format),
  MAX(state__content__details__actors),
  MAX(state__content__details__genres),
  MAX(state__content__details__asset_studios),
  MAX(state__content__programmer__vod__provider_name),
  MAX(state__content__programmer__vod__product),
  MAX(state__content__programmer__linear__channel_name),
  MAX(state__content__programmer__linear__network_name),
  MAX(state__content__programmer__linear__channel_category),
  MAX(state__content__programmer__linear__channel_number),
  MAX(state__content__programmer__linear__linear_channel_id),
  MAX(state__content__programmer__linear__linear_airing_time),
  MAX(state__ad__id),
  MAX(state__ad__title),
  MAX(state__ad__number),
  MAX(state__ad__start_timestamp),
  MAX(state__ad__ad_duration_sec),
  MAX(state__ad__ad_elapsed_sec),
  MAX(state__ad__ad_stopped_reason),
  MAX(state__ad__ad_break_start_timestamp),
  MAX(state__ad__ad_break_duration_sec),
  MAX(state__ad__ad_break_start_position),
  MAX(state__ad__ad_break_number),
  MAX(state__ad__commodity_code),
  state__ad__vast,
  MAX(state__ad__campaign),
  MAX(state__ad__device_ad_id),
  MAX(state__view__current_page__page_name),
  MAX(state__view__current_page__section),
  MAX(state__view__current_page__sub_section),
  MAX(state__view__current_page__page_id),
  MAX(state__view__current_page__page_load_time_ms),
  MAX(state__view__current_page__page_type),
  MAX(state__view__current_page__display_type),
  MAX(state__view__current_page__page_number),
  state__view__current_page__settings,
  MAX(state__view__current_page__sort_and_filter__applied_sorts),
  MAX(state__view__current_page__sort_and_filter__applied_filters),
  MAX(state__view__current_page__elements__name),
  MAX(state__view__current_page__elements__number_of_items),
  MAX(state__view__current_page__elements__widgets_type),
  MAX(state__view__current_page__elements__parentally_blocked_items),
  MAX(state__view__current_page__elements__entitled_items),
  MAX(state__view__previous_page__page_name),
  MAX(state__view__previous_page__section),
  MAX(state__view__previous_page__sub_section),
  MAX(state__view__previous_page__page_id),
  MAX(state__view__previous_page__page_viewed_time_sec),
  MAX(state__view__previous_page__page_load_time_ms),
  MAX(state__view__modal__name),
  MAX(state__view__modal__text),
  MAX(state__view__modal__modal_type),
  MAX(state__view__modal__load_time_ms),
  MAX(state__download__content_window),
  MAX(state__download__quality),
  MAX(state__download__watched),
  MAX(state__download__duration_sec),
  MAX(state__search__number_of_search_results),
  MAX(state__search__selected_result_name),
  MAX(state__search__selected_result_facet),
  MAX(state__search__text),
  MAX(state__search__search_type),
  MAX(state__search__results),
  MAX(state__search__results_ms),
  MAX(state__search__query_id),
  MAX(state__search__search_id),
  MAX(operation__toggle_state),
  MAX(operation__operation_type),
  MAX(operation__dvr_operation),
  MAX(operation__switch_screen_direction),
  MAX(operation__switch_screen_id),
  MAX(operation__success),
  MAX(operation__selected__index),
  MAX(operation__selected__view_element_name),
  MAX(operation__user_entry__enc_text),
  MAX(operation__user_entry__entry_type),
  MAX(operation__user_entry__pin_type),
  MAX(operation__user_entry__pin_change_type),
  MAX(operation__user_entry__operation_result),
  epoch_converter(cast(message__timestamp*1000 as bigint),'UTC') as partition_date_utc,
  epoch_datehour(cast(message__timestamp*1000 as bigint),'UTC') as partition_date_hour_utc
FROM ${env:tmp_dbprefix_events_no_part}
GROUP BY
  visit__visit_id,
  message__sequence_number,
  message__timestamp,
  visit__settings,
  visit__application_details__environment,
  visit__video_zone__details,
  visit__account__details,
  visit__account__demographic_data,
  visit__user__details,
  application__error__error_extras,
  state__ad__vast,
  state__view__current_page__settings
;
